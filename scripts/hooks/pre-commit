#!/bin/bash
# LLE Development Pre-commit Hook with Documentation Policy Enforcement

echo "Running pre-commit checks..."

CHECKS_FAILED=0

# ============================================================================
# DOCUMENTATION POLICY ENFORCEMENT (SAFE | ORGANIZED | CLEAN | PRUNED)
# ============================================================================

echo "Checking documentation policy compliance..."

# Rule 1: Root Directory Cleanliness
# Check for prohibited files in root
PROHIBITED_IN_ROOT=$(git diff --cached --name-only | grep -E "^[^/]*\.(o|log)$|^core\." || true)
if [ -n "$PROHIBITED_IN_ROOT" ]; then
    echo "❌ POLICY VIOLATION: Prohibited files in root directory"
    echo "   Build artifacts and logs must not be in root"
    echo "   Files:"
    echo "$PROHIBITED_IN_ROOT"
    echo ""
    CHECKS_FAILED=1
fi

# Check for markdown files in root (excluding allowed files, excluding deletions)
ROOT_MD=$(git diff --cached --name-only --diff-filter=d | grep "^[^/]*\.md$" | grep -v "^README\.md$" | grep -v "^CLAUDE\.md$" || true)
if [ -n "$ROOT_MD" ]; then
    echo "❌ POLICY VIOLATION: Markdown files must be in docs/ subdirectories"
    echo "   Only README.md and CLAUDE.md allowed in root"
    echo "   Files:"
    echo "$ROOT_MD"
    echo ""
    CHECKS_FAILED=1
fi

# Rule 2: Documentation Structure Warnings
NEW_DOCS=$(git diff --cached --name-only --diff-filter=A | grep "\.md$" || true)
if [ -n "$NEW_DOCS" ]; then
    for doc in $NEW_DOCS; do
        if ! echo "$doc" | grep -qE "^docs/(user|project|development|lle_specification|lle_implementation|archived)/|^docs/DOCUMENTATION_POLICY\.md$|^docs/VISION\.md$|^README\.md$|^CLAUDE\.md$"; then
            echo "⚠ WARNING: New markdown file outside documented structure: $doc"
            echo "   Consider placing in docs/project/ or appropriate subdirectory"
            echo "   See docs/DOCUMENTATION_POLICY.md for structure"
            echo ""
        fi
    done
fi

# Rule 3: Deletion Warning
DELETED_FILES=$(git diff --cached --name-only --diff-filter=D | grep -E "\.(md|c|h)$" || true)
if [ -n "$DELETED_FILES" ]; then
    echo "⚠ Note: File deletions detected"
    echo "   Deleted files:"
    echo "$DELETED_FILES" | head -5
    echo ""
fi

echo "✓ Documentation policy checks complete"
echo ""

# ============================================================================
# LLE-SPECIFIC ENFORCEMENT
# ============================================================================

# Check if any LLE files are being committed
LLE_FILES_CHANGED=$(git diff --cached --name-only | grep -E "include/lle/|src/lle/|tests/lle/" || true)

if [ -n "$LLE_FILES_CHANGED" ]; then
    echo "LLE source files detected in commit..."

    # Check for TODO/STUB markers in committed LLE CODE (FORBIDDEN)
    LLE_CODE_FILES=$(git diff --cached --diff-filter=d --name-only | grep -E "include/lle/.*\.(h|c)$|src/lle/.*\.(h|c)$|tests/lle/.*\.(h|c)$" || true)

    if [ -n "$LLE_CODE_FILES" ]; then
        STUB_MARKER_FOUND=""
        STUB_FOUND=""
        SIMPLIFIED_FOUND=""
        DEFERRED_FOUND=""

        for file in $LLE_CODE_FILES; do
            # Check for STUB/FIXME in comments (TODO is allowed)
            if git diff --cached "$file" | grep -E "^\+.*STUB|^\+.*FIXME" > /dev/null; then
                STUB_MARKER_FOUND="yes"
            fi

            # Check for actual stub implementations
            if git diff --cached "$file" | grep -E "^\+.*return LLE_ERROR_FEATURE_NOT_AVAILABLE|^\+.*return LLE_ERROR_NOT_IMPLEMENTED" > /dev/null; then
                STUB_FOUND="yes"
            fi

            # ZERO TOLERANCE: Check for "simplified" language in code/comments
            if git diff --cached "$file" | grep -iE "^\+.*(simplified|simplification)" > /dev/null; then
                SIMPLIFIED_FOUND="yes"
            fi

            # ZERO TOLERANCE: Check for "deferred" language in code/comments
            if git diff --cached "$file" | grep -iE "^\+.*(deferred|defer to later)" > /dev/null; then
                DEFERRED_FOUND="yes"
            fi
        done

        if [ -n "$STUB_MARKER_FOUND" ]; then
            echo "❌ COMPLIANCE VIOLATION: STUB/FIXME markers found in LLE code"
            echo ""
            echo "FORBIDDEN: LLE code must be complete. No stubs allowed."
            echo "Note: TODO comments are allowed for documenting future enhancements."
            echo ""
            CHECKS_FAILED=1
        fi

        if [ -n "$STUB_FOUND" ]; then
            echo "❌ COMPLIANCE VIOLATION: Actual stub implementations found in LLE code"
            echo ""
            echo "FORBIDDEN: Functions cannot just return error codes without implementation."
            echo ""
            CHECKS_FAILED=1
        fi

        if [ -n "$SIMPLIFIED_FOUND" ]; then
            echo "❌ ZERO TOLERANCE VIOLATION: 'Simplified' language found in LLE code"
            echo ""
            echo "FORBIDDEN: Code or comments indicating simplified implementations"
            echo ""
            CHECKS_FAILED=1
        fi

        if [ -n "$DEFERRED_FOUND" ]; then
            echo "❌ ZERO TOLERANCE VIOLATION: 'Deferred' language found in LLE code"
            echo ""
            echo "FORBIDDEN: Code or comments indicating deferred work"
            echo ""
            CHECKS_FAILED=1
        fi
    fi

    # Check for basic compilation (if build system is available)
    if [ -f "meson.build" ] && [ -d "build" ]; then
        echo "Verifying LLE compilation..."
        if meson compile -C build 2>/dev/null 1>/dev/null; then
            echo "✓ LLE files compile successfully"
        else
            echo "⚠ Warning: LLE compilation check failed"
        fi
    fi
fi

# Final result
if [ $CHECKS_FAILED -eq 1 ]; then
    echo ""
    echo "========================================="
    echo "❌ PRE-COMMIT CHECKS FAILED"
    echo "========================================="
    echo "Fix the violations above before committing."
    echo ""
    exit 1
else
    echo ""
    echo "Pre-commit checks complete ✓"
    echo ""
    exit 0
fi
