#!/bin/bash
# LLE Commit Message Validation Hook
# This runs AFTER pre-commit and receives the commit message file as $1

COMMIT_MSG_FILE="$1"
COMMIT_MSG=$(cat "$COMMIT_MSG_FILE")

# Track if any checks fail
CHECKS_FAILED=0

# ============================================================================
# UNIVERSAL EMOJI CHECK - APPLIES TO ALL COMMITS
# ============================================================================

# ZERO TOLERANCE ENFORCEMENT: Block emoji in commit messages (ALL COMMITS)
echo "Checking commit message for emoji..."
if echo "$COMMIT_MSG" | grep -qE "âœ…|âŒ|âš ï¸|âœ“|âœ—|ğŸ”¥|ğŸ’¯|â­|ğŸ“|ğŸ“‹|ğŸš€|ğŸ¯|ğŸ’¡|âš¡|ğŸ”§|ğŸ› ï¸|ğŸ“¦|ğŸ¨|â™»ï¸|ğŸ”’|ğŸš¨|ğŸ’»|ğŸ“|ğŸ› |âš™ï¸|ğŸ”¨"; then
    echo "âŒ ZERO TOLERANCE VIOLATION: Emoji detected in commit message"
    echo ""
    echo "FORBIDDEN: Professional git commits MUST NOT contain emoji"
    echo "This violates professional development standards and git log clarity"
    echo ""
    echo "Found emoji in commit message. Please remove all emoji characters."
    echo "Use plain text only: 'FIXED', 'COMPLETE', 'WARNING' instead of emoji"
    echo ""
    CHECKS_FAILED=1
else
    echo "âœ“ No emoji detected in commit message"
fi

# ============================================================================
# LLE COMMIT MESSAGE PREFIX ENFORCEMENT
# ============================================================================

# Check if LLE files are in this commit
LLE_FILES_CHANGED=$(git diff --cached --name-only | grep -E "^(src/lle/|include/lle/|tests/lle/)" || true)

if [ -n "$LLE_FILES_CHANGED" ]; then
    echo "Checking LLE commit message prefix..."

    if ! echo "$COMMIT_MSG" | grep -q "^LLE"; then
        echo "âŒ POLICY VIOLATION: LLE commits must start with 'LLE' prefix"
        echo ""
        echo "REQUIRED: LLE-related commits must begin with 'LLE' for git history clarity"
        echo "Example: 'LLE Spec 03 Phase 1: Buffer Management Foundation'"
        echo ""
        echo "When LLE work is integrated into main lusush, prefixed commits make it"
        echo "clear which work was LLE-specific vs core lusush components."
        echo ""
        CHECKS_FAILED=1
    else
        echo "âœ“ LLE commit message prefix present"
    fi

    # ZERO TOLERANCE ENFORCEMENT: Block false compliance claims (INFO ONLY)
    if echo "$COMMIT_MSG" | grep -qE "100% compliant|100% complete|zero stubs|zero TODOs|fully compliant|complete compliance"; then
        echo "ğŸ“‹ POLICY REMINDER: Compliance claim detected in commit message"
        echo ""
        echo "Claims like '100% compliant', 'zero stubs', 'fully compliant' require verification."
        echo "Ensure your code actually meets these claims before committing."
        echo ""
        # This is INFO only, not blocking
    fi
fi

# Exit with failure if any checks failed
if [ $CHECKS_FAILED -eq 1 ]; then
    echo ""
    echo "========================================="
    echo "âŒ COMMIT MESSAGE CHECKS FAILED"
    echo "========================================="
    echo "Fix the violations above before committing."
    echo ""
    exit 1
fi

exit 0
